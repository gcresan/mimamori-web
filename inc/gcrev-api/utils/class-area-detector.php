<?php
/**
 * Gcrev_Area_Detector
 *
 * ターゲットテキストから都道府県名を検出するユーティリティ。
 * Step4.5 で Gcrev_Report_Generator から分離。
 * Generator / Highlights の両方がこのクラスを参照し、循環依存を解消する。
 *
 * @package GCREV_INSIGHT
 */

if ( ! defined('ABSPATH') ) { exit; }

if ( class_exists('Gcrev_Area_Detector') ) { return; }

class Gcrev_Area_Detector {

    /**
     * ターゲットテキストから都道府県名を検出する
     *
     * @param string $target_text クライアント設定のターゲットテキスト
     * @return string|null 都道府県名（例：「愛媛県」）。全国 or 未検出なら null
     */
    public static function detect(string $target_text): ?string {

        $t = trim($target_text);
        if ($t === '') return null;

        if (mb_stripos($t, '全国') !== false) {
            return null;
        }

        $prefs = [
            '北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県',
            '茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県',
            '新潟県','富山県','石川県','福井県','山梨県','長野県',
            '岐阜県','静岡県','愛知県','三重県',
            '滋賀県','京都府','大阪府','兵庫県','奈良県','和歌山県',
            '鳥取県','島根県','岡山県','広島県','山口県',
            '徳島県','香川県','愛媛県','高知県',
            '福岡県','佐賀県','長崎県','熊本県','大分県','宮崎県','鹿児島県','沖縄県',
        ];

        foreach ($prefs as $p) {
            if (mb_stripos($t, $p) !== false) {
                return $p;
            }
        }

        // 県名省略（例：愛媛 / 東京 / 大阪）も許容
        $short = [
            '北海道' => '北海道',
            '青森' => '青森県', '岩手' => '岩手県', '宮城' => '宮城県', '秋田' => '秋田県', '山形' => '山形県', '福島' => '福島県',
            '茨城' => '茨城県', '栃木' => '栃木県', '群馬' => '群馬県', '埼玉' => '埼玉県', '千葉' => '千葉県', '東京' => '東京都', '神奈川' => '神奈川県',
            '新潟' => '新潟県', '富山' => '富山県', '石川' => '石川県', '福井' => '福井県', '山梨' => '山梨県', '長野' => '長野県',
            '岐阜' => '岐阜県', '静岡' => '静岡県', '愛知' => '愛知県', '三重' => '三重県',
            '滋賀' => '滋賀県', '京都' => '京都府', '大阪' => '大阪府', '兵庫' => '兵庫県', '奈良' => '奈良県', '和歌山' => '和歌山県',
            '鳥取' => '鳥取県', '島根' => '島根県', '岡山' => '岡山県', '広島' => '広島県', '山口' => '山口県',
            '徳島' => '徳島県', '香川' => '香川県', '愛媛' => '愛媛県', '高知' => '高知県',
            '福岡' => '福岡県', '佐賀' => '佐賀県', '長崎' => '長崎県', '熊本' => '熊本県', '大分' => '大分県', '宮崎' => '宮崎県', '鹿児島' => '鹿児島県', '沖縄' => '沖縄県',
        ];

        foreach ($short as $k => $v) {
            if (mb_stripos($t, $k) !== false) {
                return $v;
            }
        }

        return null;
    }
}
